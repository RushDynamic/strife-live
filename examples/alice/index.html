<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice</title>
    <script src="https://cdn.socket.io/4.4.0/socket.io.min.js"
        integrity="sha384-1fOn6VtTq3PWwfsOrk45LnYcGosJwzMHv+Xh/Jx5303FVOXzEnw0EpLv30mtjmlj"
        crossorigin="anonymous"></script>
    <script src="./lib.js" type="module"></script>
    <script type="module" async>
        import { StrifeLive } from './lib.js';
        var socket;
        var myAudioStream;
        async function connectToServer() {
            socket = io.connect("http://localhost:5250");
            socket.on("connect", () => {
                console.log("Connected to signaling server, sending username");
                socket.emit("username", "alice");
            });

            let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            myAudioStream = stream;
            console.log("Fetched audio stream");

            // Create peer connection
            let peerConnection = StrifeLive.createPeerConnection(myAudioStream);

            // Fetch stream handler
            peerConnection.onaddstream = (e) => {
                console.log("Setting remote audio stream");
                document.getElementById("remote-audio").srcObject = e?.stream;
            }

            // New ice candidate handler
            peerConnection.onicecandidate = (e) => {
                if (!e.candidate) return;
                // Invoke newIceCandidate event in server with e.candidate
                socket.emit('newIceCandidate', e.candidate);
            }

            // Add socket event handler for "getAnswer"
            // Set received answer as peerConnection.setRemoteDescription
            socket.on('getAnswer', async (answer) => {
                console.log("Received answer from server");
                await StrifeLive.setAnswer(answer);
            });

            // Add socket event handler for getIceCandidate
            // Set peerConnection.addIceCandidate(newCandidate)
            socket.on('getIceCandidate', async (iceCandidate) => {
                await StrifeLive.addIceCandidate(iceCandidate);
            });
        };

        async function placeCall() {
            try {
                // Create new offer
                let newOffer = await StrifeLive.createOffer();

                // Invoke getOffer event in Server with newOffer
                socket.emit('getOffer', newOffer);
            }
            catch (err) {
                console.log("Error while fetching user stream:", err);
            }
        }
        document.getElementById('btn-connect-ss').addEventListener('click', connectToServer);
        document.getElementById('btn-call').addEventListener('click', placeCall);
    </script>
</head>

<body>
    <h1>Alice</h1>
    <button id="btn-connect-ss">Connect to Server</button>
    <button id="btn-call">Call</button>
    <audio id="remote-audio" autoplay controls />
</body>

</html>